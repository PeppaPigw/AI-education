<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI-Education - æˆ‘çš„å­¦ä¹ </title>
    <style>
      /* 1. å…¨å±€å’Œé‡ç½® */
      :root {
        --primary-blue: #7a6ad8;
        --light-gray-bg: #f5f5f5;
        --white-bg: #fff;
        --border-gray: #e0e0e0;
        --text-dark: #2d2f31;
        --text-light: #5f5f5f;
        --text-dim: #9e9e9e;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        margin: 0;
        background-color: var(--white-bg); /* é¡µé¢èƒŒæ™¯æ˜¯ç™½è‰² */
        color: var(--text-dark);
        line-height: 1.5;
      }

      a {
        text-decoration: none;
        color: var(--primary-blue);
        cursor: pointer;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 24px;
      }

      /* 2. å¤´éƒ¨å¯¼èˆªæ  */
      .main-header {
        background-color: var(--white-bg);
        border-bottom: 1px solid var(--border-gray);
        padding: 10px 0;
        position: sticky;
        top: 0;
        z-index: 1000;
      }

      .navbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .nav-left {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .logo {
        font-size: 24px;
        font-weight: bold;
        color: var(--primary-blue);
        cursor: pointer;
      }

      .nav-links a {
        margin: 0 10px;
        color: var(--text-dark);
        font-weight: 500;
        font-size: 14px;
      }

      .search-bar {
        flex-grow: 1;
        max-width: 350px;
        display: flex;
        border: 1px solid var(--border-gray);
        border-radius: 4px;
      }

      .search-bar input {
        border: none;
        padding: 8px 12px;
        font-size: 14px;
        width: 100%;
        border-radius: 4px 0 0 4px;
      }
      .search-bar input:focus {
        outline: none;
      }

      .search-bar button {
        border: none;
        background-color: var(--primary-blue);
        color: white;
        padding: 0 15px;
        cursor: pointer;
        border-radius: 0 4px 4px 0;
      }

      .nav-right {
        display: flex;
        align-items: center;
        gap: 20px;
        font-size: 20px;
      }

      .notification-bell {
        position: relative;
      }

      .notification-badge {
        position: absolute;
        top: -2px;
        right: -5px;
        background-color: red;
        color: white;
        font-size: 10px;
        font-weight: bold;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .profile-icon {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background-color: #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: var(--text-dark);
      }

      /* 3. ä¸»å†…å®¹åŒºåŸŸ */
      .main-dashboard {
        padding: 32px 0;
      }

      .dashboard-layout {
        display: grid;
        grid-template-columns: 300px 1fr; /* å·¦ä¾§è¾¹æ  300pxï¼Œå³ä¾§è‡ªé€‚åº” */
        gap: 32px;
      }

      /* 4. å·¦ä¾§è¾¹æ  */
      .dashboard-sidebar {
        display: flex;
        flex-direction: column;
        gap: 24px;
      }

      .greeting-box {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .greeting-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: var(--primary-blue);
        color: var(--white-bg);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        font-weight: bold;
        flex-shrink: 0;
      }

      .greeting-text h2 {
        font-size: 20px;
        margin: 0 0 4px 0;
      }

      .greeting-text p {
        font-size: 14px;
        color: var(--text-light);
        margin: 0;
        line-height: 1.4;
      }

      .goal-tag {
        background-color: var(--light-gray-bg);
        color: var(--text-dark);
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 500;
      }

      .widget-card {
        border: 1px solid var(--border-gray);
        border-radius: 8px;
        padding: 20px;
        background-color: var(--white-bg);
      }

      .widget-card h3 {
        font-size: 18px;
        margin-top: 0;
        margin-bottom: 16px;
      }

      .goal-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .goal-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 14px;
        color: var(--text-light);
      }

      .goal-item .icon {
        font-size: 18px;
        color: var(--primary-blue);
      }

      /* 4.1 æ—¥å†å°éƒ¨ä»¶ */
      .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .calendar-week-toggles {
        display: flex;
        gap: 8px;
      }

      .calendar-week-toggles span {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-dim);
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .calendar-nav {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .calendar-nav h4 {
        margin: 0;
        font-size: 14px;
        font-weight: 600;
      }

      .calendar-nav button {
        background: none;
        border: none;
        font-size: 20px;
        color: var(--text-light);
        cursor: pointer;
      }

      .calendar-grid-header,
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
      }

      .calendar-grid-header span {
        font-size: 12px;
        color: var(--text-dim);
        padding: 8px 0;
      }

      .calendar-cell {
        font-size: 14px;
        padding: 6px 0;
        position: relative;
        color: var(--text-dark);
      }

      .calendar-cell.dimmed {
        color: var(--text-dim);
      }

      .calendar-cell.today {
        background-color: var(--light-gray-bg);
        border-radius: 50%;
        font-weight: bold;
      }

      .calendar-cell.locked {
        color: var(--text-dim);
        cursor: pointer;
      }

      .calendar-cell .lock-icon {
        font-size: 12px;
        position: absolute;
        bottom: -2px;
        left: 50%;
        transform: translateX(-50%);
      }

      .calendar-footer p {
        font-size: 12px;
        color: var(--text-light);
        margin: 12px 0 0 0;
      }

      /* 5. å³ä¾§ä¸»å†…å®¹ */
      .main-feed {
        min-width: 0; /* é˜²æ­¢ flex/grid å­é¡¹æº¢å‡º */
      }

      .feed-tabs {
        display: flex;
        gap: 20px;
        border-bottom: 1px solid var(--border-gray);
        margin-bottom: 24px;
      }

      .feed-tab {
        padding: 12px 4px;
        font-size: 16px;
        font-weight: 500;
        color: var(--text-light);
        border: none;
        background: none;
        border-bottom: 3px solid transparent;
      }

      .feed-tab.active {
        color: var(--text-dark);
        border-bottom-color: var(--primary-blue);
      }

      .feed-card {
        background-color: var(--white-bg);
        border: 1px solid var(--border-gray);
        border-radius: 8px;
        padding: 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 20px;
      }

      .feed-card .info .provider {
        font-size: 12px;
        font-weight: 500;
        color: var(--text-light);
      }

      .feed-card .info h4 {
        font-size: 18px;
        margin: 4px 0 8px 0;
      }

      .feed-card .info .progress-text {
        font-size: 14px;
        color: var(--text-light);
      }

      .feed-card .action-button {
        background-color: var(--primary-blue);
        color: #fff;
        padding: 10px 24px;
        border: none;
        border-radius: 4px;
        font-weight: bold;
        font-size: 14px;
        white-space: nowrap;
      }
      .feed-card .action-button:hover {
        opacity: 0.9;
      }

      .peer-review-card .info h4 {
        margin-bottom: 4px;
      }
      .peer-review-card .info .subtitle {
        font-size: 14px;
        color: var(--text-light);
      }

      /* 6. é¡µè„š */
      .main-footer {
        background-color: var(--light-gray-bg);
        padding: 48px 0;
        margin-top: 64px;
        border-top: 1px solid var(--border-gray);
      }

      .footer-content {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 24px;
      }

      .footer-column h5 {
        font-size: 16px;
        margin-top: 0;
        margin-bottom: 12px;
      }

      .footer-column ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .footer-column ul li a {
        font-size: 14px;
        color: var(--text-dark);
      }
      .footer-column ul li a:hover {
        text-decoration: underline;
      }

      .app-buttons img {
        max-width: 135px;
        height: auto;
        margin-bottom: 10px;
      }

      /* 7. å­¦ä¹ è®¡åˆ’æ ·å¼ */
      .plan-card {
        background-color: var(--white-bg);
        border: 1px solid var(--border-gray);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .plan-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-blue);
      }

      .plan-card.selected {
        border-color: var(--primary-blue);
        background-color: #f0f0ff;
      }

      .plan-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .plan-date {
        font-size: 14px;
        color: var(--text-light);
        font-weight: 600;
      }

      .plan-priority {
        background-color: var(--primary-blue);
        color: white;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
      }

      .plan-topic {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
      }

      .plan-materials {
        font-size: 14px;
        color: var(--text-light);
      }

      .plan-detail {
        background-color: var(--white-bg);
        border: 1px solid var(--border-gray);
        border-radius: 8px;
        padding: 24px;
        max-height: 600px;
        overflow-y: auto;
      }

      .plan-detail h3 {
        margin-top: 0;
        color: var(--text-dark);
      }

      .markdown-content {
        line-height: 1.8;
      }

      .markdown-content h3 {
        color: var(--primary-blue);
        margin-top: 24px;
        margin-bottom: 12px;
      }

      .markdown-content ul {
        padding-left: 20px;
      }

      .markdown-content li {
        margin-bottom: 8px;
      }

      .create-plan-form {
        background-color: var(--white-bg);
        border: 1px solid var(--border-gray);
        border-radius: 8px;
        padding: 24px;
      }

      .create-plan-form input,
      .create-plan-form textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-gray);
        border-radius: 4px;
        font-size: 14px;
        margin-bottom: 16px;
        font-family: inherit;
      }

      .create-plan-form input:focus,
      .create-plan-form textarea:focus {
        outline: none;
        border-color: var(--primary-blue);
      }

      .create-plan-form textarea {
        min-height: 100px;
        resize: vertical;
      }

      .create-plan-form button {
        background-color: var(--primary-blue);
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
      }

      .create-plan-form button:hover {
        opacity: 0.9;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-light);
      }

      .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
      }

      /* 8. å“åº”å¼ */
      @media (max-width: 992px) {
        .dashboard-layout {
          grid-template-columns: 1fr; /* å †å  */
        }
        .search-bar {
          display: none;
        }
      }

      @media (max-width: 768px) {
        .nav-links {
          display: none;
        }
        .footer-content {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 576px) {
        .greeting-box {
          flex-direction: column;
          align-items: flex-start;
        }
        .feed-card {
          flex-direction: column;
          align-items: flex-start;
        }
        .feed-card .action-button {
          width: 100%;
          text-align: center;
        }
        .footer-content {
          grid-template-columns: 1fr;
        }
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <header class="main-header">
      <nav class="navbar container">
        <div class="nav-left">
          <span
            class="logo"
            onclick="window.location.href='/static/mainpage.html'"
            >AI-Education</span
          >
          <div class="nav-links">
            <a href="/static/mainpage.html">é¦–é¡µ</a>
            <a href="/static/mylearning.html" style="font-weight: 600"
              >æˆ‘çš„å­¦ä¹ </a
            >
            <a href="/static/coursecontent.html">è¯¾ç¨‹å†…å®¹</a>
          </div>
        </div>

        <div class="nav-right">
          <div class="profile-icon" title="ä¸ªäººä¸­å¿ƒ" style="cursor: pointer">
            W
          </div>
        </div>
      </nav>
    </header>

    <main class="main-dashboard container">
      <div class="dashboard-layout">
        <aside class="dashboard-sidebar">
          <div class="greeting-box">
            <div class="greeting-icon">W</div>
            <div class="greeting-text">
              <h2>æ™šä¸Šå¥½, WangQiyu</h2>
              <p>
                æ‚¨çš„å­¦ä¹ ç›®æ ‡æ˜¯<strong>ç†Ÿç»ƒæŒæ¡æ•°æ®åˆ†æ</strong>, å·²é€‰æ‹©è¯¾ç¨‹
                <span class="goal-tag">å¤§æ•°æ®åŸºç¡€æ¦‚å¿µ</span>,
                <span class="goal-tag">æ•°æ®è·å–</span>,
                <span class="goal-tag">æ•°æ®è´¨é‡ä¸é¢„å¤„ç†</span>,
                <span class="goal-tag">æ•°æ®å­˜å‚¨ç³»ç»Ÿ</span>
              </p>
            </div>
          </div>

          <div class="widget-card">
            <h3>ä»Šæ—¥ç›®æ ‡</h3>
            <ul class="goal-list">
              <li class="goal-item">
                <span class="icon">â­</span> è®¿é—® Coursera
              </li>
              <li class="goal-item">
                <span class="icon">ğŸ</span> å®Œæˆä»»æ„4ä¸ªå­¦ä¹ é¡¹ç›® 1/4
              </li>
              <li class="goal-item">
                <span class="icon">ğŸ“…</span> åˆ¶å®šå­¦ä¹ è®¡åˆ’
              </li>
            </ul>
          </div>

          <div class="widget-card">
            <div class="calendar-header">
              <h3>å­¦ä¹ æ—¥å†</h3>
              <a href="#" onclick="showCreatePlanForm(); return false;"
                >+ åˆ¶å®šè®¡åˆ’</a
              >
            </div>

            <div class="calendar-nav">
              <button type="button" id="prev-month">&lt;</button>
              <h4 id="calendar-title">åŠ è½½ä¸­...</h4>
              <button type="button" id="next-month">&gt;</button>
            </div>

            <div class="calendar-grid-header">
              <span>æ—¥</span><span>ä¸€</span><span>äºŒ</span><span>ä¸‰</span
              ><span>å››</span><span>äº”</span><span>å…­</span>
            </div>

            <div class="calendar-grid" id="calendar-grid">
              <!-- æ—¥å†å•å…ƒæ ¼å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>

            <div class="calendar-footer">
              <p id="calendar-stats">æœ¬æœˆå­¦ä¹ è®¡åˆ’ï¼š0 ä¸ª</p>
            </div>
          </div>
        </aside>

        <section class="main-feed">
          <div class="feed-tabs">
            <button class="feed-tab active" onclick="showPlansTab()">
              æˆ‘çš„å­¦ä¹ è®¡åˆ’
            </button>
            <button class="feed-tab" onclick="showCreateTab()">
              åˆ›å»ºæ–°è®¡åˆ’
            </button>
          </div>

          <!-- å­¦ä¹ è®¡åˆ’åˆ—è¡¨ -->
          <div id="plans-tab">
            <div id="plans-list">
              <!-- å­¦ä¹ è®¡åˆ’åˆ—è¡¨å°†ç”±JavaScriptåŠ¨æ€ç”Ÿæˆ -->
              <div class="empty-state">
                <div class="empty-state-icon">ğŸ“‹</div>
                <p>åŠ è½½å­¦ä¹ è®¡åˆ’ä¸­...</p>
              </div>
            </div>
          </div>

          <!-- åˆ›å»ºæ–°è®¡åˆ’è¡¨å• -->
          <div id="create-tab" style="display: none">
            <div class="create-plan-form">
              <h3>ğŸ“ åˆ›å»ºæ–°çš„å­¦ä¹ è®¡åˆ’</h3>
              <p style="color: var(--text-light); margin-bottom: 20px">
                æ ¹æ®æ‚¨çš„å­¦ä¹ ç›®æ ‡ï¼Œæˆ‘ä»¬å°†ä¸ºæ‚¨ç”Ÿæˆä¸ªæ€§åŒ–çš„å­¦ä¹ è®¡åˆ’
              </p>

              <label
                style="display: block; margin-bottom: 8px; font-weight: 600"
                >å§“å</label
              >
              <input
                type="text"
                id="plan-name"
                placeholder="è¯·è¾“å…¥æ‚¨çš„å§“åï¼Œä¾‹å¦‚ï¼šå¼ ä¸‰"
              />

              <label
                style="display: block; margin-bottom: 8px; font-weight: 600"
              >
                å­¦ä¹ ç›®æ ‡
                <span style="color: var(--text-light); font-weight: normal"
                  >ï¼ˆç”¨åˆ†å·éš”å¼€å¤šä¸ªç›®æ ‡ï¼‰</span
                >
              </label>
              <textarea
                id="plan-goals"
                placeholder="ä¾‹å¦‚ï¼šæŒæ¡PythonåŸºç¡€; å­¦ä¹ æ•°æ®åˆ†æ; äº†è§£æœºå™¨å­¦ä¹ "
              ></textarea>

              <label
                style="display: block; margin-bottom: 8px; font-weight: 600"
                >è¯­è¨€</label
              >
              <select
                id="lang-select"
                style="
                  width: 100%;
                  padding: 12px;
                  border: 1px solid var(--border-gray);
                  border-radius: 4px;
                  margin-bottom: 16px;
                "
              >
                <option>ğŸŒ Auto-detect</option>
              </select>

              <label
                style="display: block; margin-bottom: 8px; font-weight: 600"
                >å®ŒæˆæœŸé™</label
              >
              <select
                id="plan-deadline"
                style="
                  width: 100%;
                  padding: 12px;
                  border: 1px solid var(--border-gray);
                  border-radius: 4px;
                  margin-bottom: 16px;
                "
              >
                <option value="1">1å¤©</option>
                <option value="3">3å¤©</option>
                <option value="7" selected>1å‘¨</option>
                <option value="14">2å‘¨</option>
                <option value="30">1ä¸ªæœˆ</option>
              </select>

              <button onclick="generatePlan()">ğŸš€ ç”Ÿæˆå­¦ä¹ è®¡åˆ’</button>

              <div id="plan-output" style="margin-top: 20px"></div>
            </div>
          </div>
        </section>
      </div>
    </main>
    <script>
      const API_BASE = "";
      let allPlans = [];
      let currentMonth = new Date();
      let selectedPlanIndex = null;

      // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", async () => {
        console.log("My Learning page loaded");
        await loadLanguages();
        await loadPlans();
        renderCalendar();

        // è®¾ç½®æ—¥å†å¯¼èˆªæŒ‰é’®
        document.getElementById("prev-month").addEventListener("click", () => {
          currentMonth.setMonth(currentMonth.getMonth() - 1);
          renderCalendar();
        });

        document.getElementById("next-month").addEventListener("click", () => {
          currentMonth.setMonth(currentMonth.getMonth() + 1);
          renderCalendar();
        });
      });

      // åŠ è½½æ”¯æŒçš„è¯­è¨€åˆ—è¡¨
      async function loadLanguages() {
        try {
          const response = await fetch(`${API_BASE}/api/languages`);
          const languages = await response.json();
          const select = document.getElementById("lang-select");
          select.innerHTML = languages
            .map((lang) => `<option>${lang}</option>`)
            .join("");
        } catch (error) {
          console.error("Error loading languages:", error);
        }
      }

      // åŠ è½½æ‰€æœ‰å­¦ä¹ è®¡åˆ’
      async function loadPlans() {
        try {
          const response = await fetch(`${API_BASE}/api/learning-plans`);
          if (!response.ok) {
            throw new Error("Failed to fetch plans");
          }

          const plans = await response.json();
          allPlans = plans.map((plan) => ({
            filename: plan.filename,
            data: plan.data,
            date: extractDateFromFilename(plan.filename),
          }));

          renderPlansList();
          updateCalendarStats();
        } catch (error) {
          console.error("Error loading plans:", error);
          showEmptyState("æ— æ³•åŠ è½½å­¦ä¹ è®¡åˆ’");
        }
      }

      // ä»æ–‡ä»¶åæå–æ—¥æœŸ
      function extractDateFromFilename(filename) {
        const match = filename.match(/(\d{8})_(\d{6})/);
        if (match) {
          const dateStr = match[1];
          const year = dateStr.substring(0, 4);
          const month = dateStr.substring(4, 6);
          const day = dateStr.substring(6, 8);
          return `${year}-${month}-${day}`;
        }
        return new Date().toISOString().split("T")[0];
      }

      // æ¸²æŸ“å­¦ä¹ è®¡åˆ’åˆ—è¡¨
      function renderPlansList() {
        const container = document.getElementById("plans-list");

        if (allPlans.length === 0) {
          showEmptyState('æš‚æ— å­¦ä¹ è®¡åˆ’ï¼Œç‚¹å‡»"åˆ›å»ºæ–°è®¡åˆ’"å¼€å§‹åˆ¶å®šæ‚¨çš„å­¦ä¹ è®¡åˆ’');
          return;
        }

        // ======= å·¥å…·å‡½æ•°ï¼šç»Ÿè®¡æ¯ä¸ªå°èŠ‚åŠæ€»æ•° =======
        function parseMaterialsBySection(materials) {
          if (!Array.isArray(materials)) return [];
          const text = materials.join("\n");
          const sections = text.split(/^###\s+/m).slice(1);
          return sections.map((section) => {
            const [title, ...body] = section.split("\n");
            const count = (
              body.join("\n").match(/^\s*\d+\.\s+\*\*.*\*\*/gm) || []
            ).length;
            return { title: title.trim(), count };
          });
        }

        function countLearningMaterials(materials) {
          return parseMaterialsBySection(materials).reduce(
            (sum, s) => sum + s.count,
            0
          );
        }

        container.innerHTML = allPlans
          .map((plan, index) => {
            const firstEntry = plan.data[0];
            const sections = parseMaterialsBySection(firstEntry.materials);
            const materialsCount = countLearningMaterials(firstEntry.materials);

            const sectionText = sections
              .map((s) => `${s.title}ï¼š${s.count} æ¡`)
              .join("ï¼Œ ");
            const deadlineInfo = firstEntry.deadline
              ? `<div class="plan-deadline" style="color: #ff6b6b; font-size: 12px; margin-top: 4px;">â° æˆªæ­¢æ—¥æœŸ: ${firstEntry.deadline}</div>`
              : "";

            return `
        <div class="plan-card ${selectedPlanIndex === index ? "selected" : ""}" 
             onclick="selectPlan(${index})">
          <div class="plan-header">
            <div class="plan-date">ğŸ“… ${firstEntry.date}</div>
            <div class="plan-priority">${firstEntry.priority}</div>
          </div>
          <div class="plan-topic">${firstEntry.topic}</div>
          <div class="plan-materials">
            ğŸ“š å…± ${materialsCount} ä¸ªå­¦ä¹ ææ–™
            <div class="plan-section-details">(${sectionText})</div>
          </div>
          ${deadlineInfo}
        </div>
      `;
          })
          .join("");
        if (selectedPlanIndex !== null) {
          showPlanDetail(selectedPlanIndex);
        }
      }

      // æ˜¾ç¤ºç©ºçŠ¶æ€
      function showEmptyState(message) {
        const container = document.getElementById("plans-list");
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‹</div>
            <p>${message}</p>
          </div>
        `;
      }

      // é€‰ä¸­ä¸€ä¸ªå­¦ä¹ è®¡åˆ’
      function selectPlan(index) {
        selectedPlanIndex = index;
        renderPlansList();
      }

      // æ˜¾ç¤ºè®¡åˆ’è¯¦æƒ…
      function showPlanDetail(index) {
        const plan = allPlans[index];
        const container = document.getElementById("plans-list");

        const detailHTML = `
          <div class="plan-card selected">
            <div class="plan-header">
              <div class="plan-date">ğŸ“… ${plan.data[0].date}</div>
              <div class="plan-priority">${plan.data[0].priority}</div>
            </div>
            <div class="plan-topic">${plan.data[0].topic}</div>
          </div>
          <div class="plan-detail">
            ${formatPlanMarkdown(plan.data)}
          </div>
          <button class="action-button" style="margin-top: 16px;" onclick="selectedPlanIndex = null; renderPlansList()">
            â† è¿”å›åˆ—è¡¨
          </button>
        `;

        container.innerHTML = detailHTML;
      }

      // æ ¼å¼åŒ–å­¦ä¹ è®¡åˆ’ä¸ºHTMLï¼ˆä½¿ç”¨markedï¼‰
      function formatPlanMarkdown(planData) {
        const markdown = planData
          .map((entry) => {
            const deadlineInfo = entry.deadline
              ? `**æˆªæ­¢æ—¥æœŸ**: â° ${entry.deadline}\n\n`
              : "";
            return (
              `### ğŸ“… ${entry.date}\n\n` +
              `**ä¸»é¢˜**: ${entry.topic}\n\n` +
              `**ä¼˜å…ˆçº§**: ${entry.priority}\n\n` +
              deadlineInfo +
              `**æ¨èææ–™**:\n\n${entry.materials
                .map((m) => `- ${m}`)
                .join("\n")}`
            );
          })
          .join("\n\n---\n\n");

        return marked.parse(markdown);
      }

      // æ¸²æŸ“æ—¥å†
      function renderCalendar() {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();

        // æ›´æ–°æ ‡é¢˜
        const monthNames = [
          "ä¸€æœˆ",
          "äºŒæœˆ",
          "ä¸‰æœˆ",
          "å››æœˆ",
          "äº”æœˆ",
          "å…­æœˆ",
          "ä¸ƒæœˆ",
          "å…«æœˆ",
          "ä¹æœˆ",
          "åæœˆ",
          "åä¸€æœˆ",
          "åäºŒæœˆ",
        ];
        document.getElementById(
          "calendar-title"
        ).textContent = `${monthNames[month]} ${year}`;

        // è·å–å½“æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const firstDayOfWeek = firstDay.getDay(); // 0 = å‘¨æ—¥
        const daysInMonth = lastDay.getDate();

        // è·å–ä¸Šä¸ªæœˆçš„å¤©æ•°
        const lastDayPrevMonth = new Date(year, month, 0).getDate();

        const grid = document.getElementById("calendar-grid");
        grid.innerHTML = "";

        // è·å–ä»Šå¤©çš„æ—¥æœŸ
        const today = new Date();
        const isCurrentMonth =
          today.getFullYear() === year && today.getMonth() === month;
        const todayDate = today.getDate();

        // æ·»åŠ ä¸Šä¸ªæœˆçš„æ—¥æœŸï¼ˆç°è‰²ï¼‰
        for (let i = firstDayOfWeek - 1; i >= 0; i--) {
          const cell = document.createElement("div");
          cell.className = "calendar-cell dimmed";
          cell.textContent = lastDayPrevMonth - i;
          grid.appendChild(cell);
        }

        // æ·»åŠ å½“æœˆçš„æ—¥æœŸ
        for (let day = 1; day <= daysInMonth; day++) {
          const cell = document.createElement("div");
          cell.className = "calendar-cell";

          if (isCurrentMonth && day === todayDate) {
            cell.classList.add("today");
          }

          // æ£€æŸ¥æ˜¯å¦æœ‰å­¦ä¹ è®¡åˆ’åœ¨è¿™ä¸€å¤©
          const dateStr = `${year}-${String(month + 1).padStart(
            2,
            "0"
          )}-${String(day).padStart(2, "0")}`;
          const hasPlan = allPlans.some((plan) =>
            plan.data.some((entry) => entry.date === dateStr)
          );

          const hasDeadline = allPlans.some((plan) =>
            plan.data.some((entry) => entry.deadline === dateStr)
          );

          if (hasDeadline) {
            cell.style.fontWeight = "bold";
            cell.style.backgroundColor = "#ffebee";
            cell.style.color = "#d32f2f";
            cell.style.borderRadius = "4px";
            cell.title = "â° æˆªæ­¢æ—¥æœŸ";
          } else if (hasPlan) {
            cell.style.fontWeight = "bold";
            cell.style.color = "var(--primary-blue)";
            cell.title = "æœ‰å­¦ä¹ è®¡åˆ’";
          }

          cell.textContent = day;
          grid.appendChild(cell);
        }

        // æ·»åŠ ä¸‹ä¸ªæœˆçš„æ—¥æœŸï¼ˆç°è‰²ï¼‰
        const totalCells = firstDayOfWeek + daysInMonth;
        const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
        for (let day = 1; day <= remainingCells; day++) {
          const cell = document.createElement("div");
          cell.className = "calendar-cell dimmed";
          cell.textContent = day;
          grid.appendChild(cell);
        }

        updateCalendarStats();
      }

      // æ›´æ–°æ—¥å†ç»Ÿè®¡ä¿¡æ¯
      function updateCalendarStats() {
        const year = currentMonth.getFullYear();
        const month = currentMonth.getMonth();

        const plansThisMonth = allPlans.filter((plan) => {
          const planDate = new Date(plan.date);
          return (
            planDate.getFullYear() === year && planDate.getMonth() === month
          );
        }).length;

        document.getElementById(
          "calendar-stats"
        ).textContent = `æœ¬æœˆå­¦ä¹ è®¡åˆ’ï¼š${plansThisMonth} ä¸ª | æ€»è®¡ï¼š${allPlans.length} ä¸ª`;
      }

      // åˆ‡æ¢åˆ°å­¦ä¹ è®¡åˆ’æ ‡ç­¾é¡µ
      function showPlansTab() {
        document.getElementById("plans-tab").style.display = "block";
        document.getElementById("create-tab").style.display = "none";
        document.querySelectorAll(".feed-tab")[0].classList.add("active");
        document.querySelectorAll(".feed-tab")[1].classList.remove("active");
      }

      // åˆ‡æ¢åˆ°åˆ›å»ºè®¡åˆ’æ ‡ç­¾é¡µ
      function showCreateTab() {
        document.getElementById("plans-tab").style.display = "none";
        document.getElementById("create-tab").style.display = "block";
        document.querySelectorAll(".feed-tab")[1].classList.add("active");
        document.querySelectorAll(".feed-tab")[0].classList.remove("active");
      }

      // æ˜¾ç¤ºåˆ›å»ºè®¡åˆ’è¡¨å•ï¼ˆä»æ—¥å†é“¾æ¥ç‚¹å‡»ï¼‰
      function showCreatePlanForm() {
        showCreateTab();
      }

      // ç”Ÿæˆå­¦ä¹ è®¡åˆ’
      async function generatePlan() {
        const name = document.getElementById("plan-name").value.trim();
        const goals = document.getElementById("plan-goals").value.trim();
        const langChoice = document.getElementById("lang-select").value;
        const deadlineDays = parseInt(
          document.getElementById("plan-deadline").value
        );

        if (!name || !goals) {
          alert("è¯·è¾“å…¥å§“åå’Œå­¦ä¹ ç›®æ ‡");
          return;
        }

        const output = document.getElementById("plan-output");
        output.innerHTML =
          '<p style="text-align: center; color: var(--text-light);">â³ æ­£åœ¨ç”Ÿæˆå­¦ä¹ è®¡åˆ’ï¼Œè¯·ç¨å€™...</p>';

        try {
          const response = await fetch(`${API_BASE}/api/learning-plan`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name: name,
              goals: goals,
              lang_choice: langChoice,
              deadline_days: deadlineDays,
            }),
          });

          if (!response.ok) {
            throw new Error("ç”Ÿæˆå¤±è´¥");
          }

          const data = await response.json();
          const formattedPlan = formatPlanMarkdown(data.plan);

          output.innerHTML = `
            <div style="padding: 20px; background-color: var(--light-gray-bg); border-radius: 8px;">
              <h4 style="color: var(--primary-blue); margin-top: 0;">âœ… ${data.message}</h4>
              <div class="markdown-content">${formattedPlan}</div>
              <button class="action-button" onclick="reloadPlans()" style="margin-top: 16px;">
                åˆ·æ–°è®¡åˆ’åˆ—è¡¨
              </button>
            </div>
          `;
        } catch (error) {
          console.error("Error generating plan:", error);
          output.innerHTML = `
            <div style="padding: 20px; background-color: #fee; border-radius: 8px; color: #c00;">
              <p>âŒ ç”Ÿæˆå­¦ä¹ è®¡åˆ’å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
            </div>
          `;
        }
      }

      // é‡æ–°åŠ è½½å­¦ä¹ è®¡åˆ’
      async function reloadPlans() {
        await loadPlans();
        showPlansTab();
      }
    </script>
  </body>
</html>
