<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI-Education - æˆ‘çš„å­¦ä¹ </title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --primary-blue: #7a6ad8;
        --light-gray-bg: #f5f5f5;
        --white-bg: #fff;
        --border-gray: #e0e0e0;
        --text-dark: #2d2f31;
        --text-light: #5f5f5f;
        --text-dim: #9e9e9e;
        --hover-bg: #f8f9fa;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: var(--light-gray-bg);
        color: var(--text-dark);
        line-height: 1.6;
        overflow: hidden;
        height: 100vh;
      }

      /* Header */
      .main-header {
        background-color: var(--white-bg);
        border-bottom: 1px solid var(--border-gray);
        padding: 12px 24px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 1000;
        height: 60px;
      }

      .logo {
        font-size: 24px;
        font-weight: bold;
        color: var(--primary-blue);
        cursor: pointer;
      }

      .nav-links {
        display: flex;
        gap: 24px;
      }

      .nav-links a {
        color: var(--text-dark);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s;
      }

      .nav-links a:hover,
      .nav-links a.active {
        color: var(--primary-blue);
      }

      /* Main Layout - 3 columns */
      .main-container {
        display: grid;
        grid-template-columns: 280px 1fr 380px;
        height: calc(100vh - 60px);
        gap: 0;
      }

      /* Left Sidebar - Mini TOC */
      .left-sidebar {
        background-color: var(--white-bg);
        border-right: 1px solid var(--border-gray);
        overflow-y: auto;
        padding: 20px;
      }

      .sidebar-title {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .toc-tree {
        list-style: none;
      }

      .toc-chapter {
        margin-bottom: 12px;
      }

      .toc-chapter-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 6px;
        font-weight: 600;
        font-size: 14px;
        color: var(--text-dark);
        transition: background-color 0.2s;
        user-select: none;
        position: relative;
      }

      .toc-chapter-header:hover {
        background-color: var(--hover-bg);
      }

      .toc-chapter-header.active {
        background-color: #f0edff;
        color: var(--primary-blue);
      }

      .toc-toggle {
        font-size: 12px;
        transition: transform 0.2s;
      }

      .toc-toggle.expanded {
        transform: rotate(90deg);
      }

      .toc-sections {
        list-style: none;
        padding-left: 24px;
        margin-top: 4px;
        display: none;
      }

      .toc-sections.show {
        display: block;
      }

      .toc-section-item {
        padding: 6px 12px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 13px;
        color: var(--text-light);
        transition: all 0.2s;
        margin-bottom: 2px;
        position: relative;
      }

      .toc-section-item:hover {
        background-color: var(--hover-bg);
        color: var(--text-dark);
      }

      .toc-section-item.active {
        background-color: #f0edff;
        color: var(--primary-blue);
        font-weight: 500;
      }

      .toc-knowledge-points {
        list-style: none;
        padding-left: 20px;
        margin-top: 2px;
      }

      .toc-knowledge-item {
        padding: 4px 8px;
        cursor: pointer;
        border-radius: 4px;
        font-size: 12px;
        color: var(--text-dim);
        transition: all 0.2s;
        position: relative;
      }

      .completed-badge {
        display: inline-block;
        background-color: #4caf50;
        color: white;
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 8px;
        font-weight: 600;
      }

      .toc-knowledge-item:hover {
        background-color: var(--hover-bg);
        color: var(--text-dark);
      }

      .toc-knowledge-item.active {
        background-color: #f0edff;
        color: var(--primary-blue);
      }

      /* Middle Panel - Resource Display */
      .middle-panel {
        background-color: #fafafa;
        overflow-y: auto;
        position: relative;
      }

      .welcome-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-light);
        padding: 40px;
        text-align: center;
      }

      .welcome-icon {
        font-size: 80px;
        margin-bottom: 20px;
      }

      .welcome-screen h2 {
        font-size: 28px;
        color: var(--text-dark);
        margin-bottom: 12px;
      }

      .welcome-screen p {
        font-size: 16px;
        max-width: 500px;
        line-height: 1.8;
      }

      .resource-container {
        display: none;
        height: 100%;
        flex-direction: column;
      }

      .resource-header {
        background-color: var(--white-bg);
        border-bottom: 1px solid var(--border-gray);
        padding: 16px 24px;
      }

      .resource-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
      }

      .resource-list {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .resource-badge {
        background-color: var(--light-gray-bg);
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 12px;
        color: var(--text-light);
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
      }

      .resource-badge:hover {
        background-color: var(--hover-bg);
        color: var(--text-dark);
      }

      .resource-badge.active {
        background-color: #f0edff;
        color: var(--primary-blue);
        border-color: var(--primary-blue);
        font-weight: 500;
      }

      .resource-viewer {
        flex: 1;
        background-color: #fafafa;
        position: relative;
      }

      #pdf-viewer,
      #video-player {
        width: 100%;
        height: 100%;
        border: none;
      }

      .no-resource {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-dim);
        font-size: 16px;
      }

      /* Right Sidebar - AI Assistant */
      .right-sidebar {
        background-color: var(--white-bg);
        border-left: 1px solid var(--border-gray);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .ai-tabs {
        display: flex;
        border-bottom: 1px solid var(--border-gray);
        background-color: var(--white-bg);
      }

      .ai-tab {
        flex: 1;
        padding: 14px 16px;
        text-align: center;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        color: var(--text-light);
        background: none;
        border: none;
        border-bottom: 3px solid transparent;
        transition: all 0.2s;
      }

      .ai-tab:hover {
        background-color: var(--hover-bg);
      }

      .ai-tab.active {
        color: var(--primary-blue);
        border-bottom-color: var(--primary-blue);
      }

      .ai-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        display: none;
      }

      .ai-content.active {
        display: block;
      }

      /* Chat */
      #chat-messages {
        min-height: 300px;
        margin-bottom: 16px;
      }

      .chat-message {
        margin-bottom: 16px;
        padding: 12px 16px;
        border-radius: 8px;
        max-width: 100%;
        word-wrap: break-word;
      }

      .chat-message.user {
        background-color: #f0edff;
        margin-left: 20px;
      }

      .chat-message.bot {
        background-color: var(--light-gray-bg);
        margin-right: 20px;
      }

      .chat-message.loading {
        background-color: var(--light-gray-bg);
        padding: 12px 16px;
        margin-right: 20px;
      }

      .loading-dots {
        display: inline-block;
      }

      .loading-dots::after {
        content: "...";
        animation: dots 1.5s steps(4, end) infinite;
      }

      @keyframes dots {
        0%,
        20% {
          content: ".";
        }
        40% {
          content: "..";
        }
        60%,
        100% {
          content: "...";
        }
      }

      .chat-input-area {
        padding: 16px;
        background-color: var(--white-bg);
        border-top: 1px solid var(--border-gray);
      }

      .chat-input-row {
        display: flex;
        gap: 8px;
      }

      .chat-input-row input {
        flex: 1;
        padding: 10px 14px;
        border: 1px solid var(--border-gray);
        border-radius: 6px;
        font-size: 14px;
        font-family: inherit;
      }

      .chat-input-row input:focus {
        outline: none;
        border-color: var(--primary-blue);
      }

      .chat-input-row button {
        padding: 10px 20px;
        background-color: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .chat-input-row button:hover {
        opacity: 0.9;
      }

      /* Summary */
      .summary-controls {
        margin-bottom: 16px;
      }

      .summary-controls input {
        width: 100%;
        padding: 10px 14px;
        border: 1px solid var(--border-gray);
        border-radius: 6px;
        font-size: 14px;
        margin-bottom: 12px;
        font-family: inherit;
      }

      .summary-controls input:focus {
        outline: none;
        border-color: var(--primary-blue);
      }

      .summary-controls button {
        width: 100%;
        padding: 10px;
        background-color: var(--primary-blue);
        color: white;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: opacity 0.2s;
      }

      .summary-controls button:hover {
        opacity: 0.9;
      }

      #summary-output {
        background-color: var(--light-gray-bg);
        padding: 16px;
        border-radius: 8px;
        min-height: 200px;
        color: var(--text-light);
      }

      /* Quiz Section */
      .quiz-section {
        text-align: center;
      }

      .quiz-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 32px;
        border-radius: 12px;
        color: white;
        margin-bottom: 20px;
      }

      .quiz-card h3 {
        font-size: 24px;
        margin-bottom: 12px;
      }

      .quiz-card p {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 24px;
      }

      .quiz-button {
        width: 100%;
        padding: 12px;
        background-color: white;
        color: #667eea;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 14px;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .quiz-button:hover {
        transform: translateY(-2px);
      }

      .quiz-topics {
        text-align: left;
      }

      .quiz-topic-item {
        background-color: var(--light-gray-bg);
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .quiz-topic-item:hover {
        background-color: #f0edff;
        color: var(--primary-blue);
      }

      /* Markdown content */
      .markdown-content {
        line-height: 1.8;
      }

      .markdown-content h1,
      .markdown-content h2,
      .markdown-content h3,
      .markdown-content h4 {
        color: var(--primary-blue);
        margin-top: 20px;
        margin-bottom: 12px;
      }

      .markdown-content ul,
      .markdown-content ol {
        padding-left: 24px;
        margin-bottom: 12px;
      }

      .markdown-content li {
        margin-bottom: 6px;
      }

      .markdown-content code {
        background-color: var(--light-gray-bg);
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 13px;
      }

      .markdown-content pre {
        background-color: var(--light-gray-bg);
        padding: 12px;
        border-radius: 6px;
        overflow-x: auto;
        margin-bottom: 12px;
      }

      .markdown-content pre code {
        background: none;
        padding: 0;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }

      ::-webkit-scrollbar-thumb {
        background: #c1c1c1;
        border-radius: 4px;
      }

      ::-webkit-scrollbar-thumb:hover {
        background: #a1a1a1;
      }

      /* Responsive */
      @media (max-width: 1200px) {
        .main-container {
          grid-template-columns: 240px 1fr 320px;
        }
      }

      @media (max-width: 992px) {
        .main-container {
          grid-template-columns: 200px 1fr;
        }

        .right-sidebar {
          display: none;
        }
      }

      @media (max-width: 768px) {
        .main-container {
          grid-template-columns: 1fr;
        }

        .left-sidebar {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="main-header">
      <div style="display: flex; align-items: center; gap: 32px">
        <span
          class="logo"
          onclick="window.location.href='/static/mainpage.html'"
          >AI-Education</span
        >
        <nav class="nav-links">
          <a href="/static/mainpage.html">é¦–é¡µ</a>
          <a href="/static/mylearning.html">æˆ‘çš„å­¦ä¹ </a>
          <a href="/static/coursecontent.html" class="active">è¯¾ç¨‹å†…å®¹</a>
        </nav>
      </div>
      <div style="display: flex; align-items: center; gap: 16px">
        <div
          style="
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--primary-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            cursor: pointer;
          "
          title="ä¸ªäººä¸­å¿ƒ"
        >
          W
        </div>
      </div>
    </header>

    <!-- Main 3-Column Layout -->
    <div class="main-container">
      <!-- Left Sidebar: Mini TOC -->
      <aside class="left-sidebar">
        <div class="sidebar-title">
          <span>ğŸ“š</span>
          <span>è¯¾ç¨‹ç›®å½•</span>
        </div>
        <ul class="toc-tree" id="toc-tree">
          <!-- Dynamic content will be inserted here -->
          <li style="text-align: center; color: var(--text-dim); padding: 20px">
            åŠ è½½ä¸­...
          </li>
        </ul>
      </aside>

      <!-- Middle Panel: Resource Display -->
      <section class="middle-panel">
        <!-- Welcome Screen -->
        <div class="welcome-screen" id="welcome-screen">
          <div class="welcome-icon">ğŸ“</div>
          <h2>æ¬¢è¿æ¥åˆ°æˆ‘çš„å­¦ä¹ </h2>
          <p>
            ç‚¹å‡»å·¦ä¾§ç›®å½•é€‰æ‹©ç« èŠ‚ï¼ŒæŸ¥çœ‹è¯¾ç¨‹èµ„æºã€‚<br />
            å³ä¾§çš„ AI åŠ©æ•™éšæ—¶å‡†å¤‡ä¸ºæ‚¨è§£ç­”é—®é¢˜ã€‚
          </p>
        </div>

        <!-- Resource Container -->
        <div class="resource-container" id="resource-container">
          <div class="resource-header">
            <div class="resource-title" id="resource-title">èµ„æºåˆ—è¡¨</div>
            <div class="resource-list" id="resource-list">
              <!-- Dynamic resource badges -->
            </div>
          </div>
          <div class="resource-viewer">
            <div class="no-resource" id="no-resource">è¯·é€‰æ‹©å·¦ä¾§çš„èµ„æºæŸ¥çœ‹</div>
            <iframe id="pdf-viewer" style="display: none"></iframe>
            <video id="video-player" controls style="display: none"></video>
          </div>
        </div>
      </section>

      <!-- Right Sidebar: AI Assistant -->
      <aside class="right-sidebar">
        <div class="ai-tabs">
          <button class="ai-tab active" data-tab="chat">ğŸ’¬ AI åŠ©æ•™</button>
          <button class="ai-tab" data-tab="summary">ğŸ“ æ€»ç»“</button>
          <button class="ai-tab" data-tab="quiz">ğŸ“‹ æµ‹éªŒ</button>
        </div>

        <!-- Chat Tab -->
        <div class="ai-content active" id="chat-content">
          <div id="chat-messages">
            <div class="chat-message bot">
              ä½ å¥½ï¼æˆ‘æ˜¯ AI åŠ©æ•™ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©ä½ çš„å—ï¼Ÿ
            </div>
          </div>
        </div>

        <!-- Summary Tab -->
        <div class="ai-content" id="summary-content">
          <div class="summary-controls">
            <input
              type="text"
              id="summary-topic"
              placeholder="è¾“å…¥è¦æ€»ç»“çš„ä¸»é¢˜..."
            />
            <button id="generate-summary-btn">âœ¨ ç”Ÿæˆæ€»ç»“</button>
          </div>
          <div id="summary-output">
            <p style="color: var(--text-dim)">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”ŸæˆçŸ¥è¯†æ€»ç»“</p>
          </div>
        </div>

        <!-- Quiz Tab -->
        <div class="ai-content" id="quiz-content">
          <div class="quiz-section">
            <div class="quiz-card">
              <h3>ğŸ“ åœ¨çº¿æµ‹éªŒ</h3>
              <p>æµ‹è¯•ä½ çš„å­¦ä¹ æˆæœï¼Œå·©å›ºçŸ¥è¯†ç‚¹</p>
              <button class="quiz-button" id="start-quiz-btn">å¼€å§‹æµ‹éªŒ</button>
            </div>

            <div class="quiz-topics">
              <h4 style="margin-bottom: 12px; font-size: 14px">å¿«é€Ÿæµ‹éªŒä¸»é¢˜</h4>
              <div class="quiz-topic-item" data-topic="å¤§æ•°æ®åŸºç¡€æ¦‚å¿µ">
                <span>å¤§æ•°æ®åŸºç¡€æ¦‚å¿µ</span>
                <span>â†’</span>
              </div>
              <div class="quiz-topic-item" data-topic="æ•°æ®è·å–">
                <span>æ•°æ®è·å–</span>
                <span>â†’</span>
              </div>
              <div class="quiz-topic-item" data-topic="æ•°æ®é¢„å¤„ç†">
                <span>æ•°æ®é¢„å¤„ç†</span>
                <span>â†’</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Input (sticky at bottom) -->
        <div class="chat-input-area">
          <div class="chat-input-row">
            <input type="text" id="chat-input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." />
            <button id="send-chat-btn">å‘é€</button>
          </div>
        </div>
      </aside>
    </div>

    <script>
      const API_BASE = "";
      let courseData = null;
      let currentNode = null;
      let currentResources = [];
      let chatHistory = [];
      let currentHls = null;

      // Initialize
      document.addEventListener("DOMContentLoaded", async () => {
        console.log("My Learning page loaded");
        await loadCourseData();
        setupEventListeners();
      });

      // Load course data
      async function loadCourseData() {
        try {
          const response = await fetch(`${API_BASE}/api/knowledge-graph`);
          courseData = await response.json();
          console.log("Course data loaded:", courseData);
          renderTOC();
        } catch (error) {
          console.error("Error loading course data:", error);
          document.getElementById("toc-tree").innerHTML =
            '<li style="text-align: center; color: red; padding: 20px">åŠ è½½å¤±è´¥</li>';
        }
      }

      // Render Table of Contents
      function renderTOC() {
        if (!courseData || !courseData.children) return;

        const tocTree = document.getElementById("toc-tree");
        tocTree.innerHTML = "";

        courseData.children.forEach((chapter, chapterIndex) => {
          const chapterLi = document.createElement("li");
          chapterLi.className = "toc-chapter";

          const chapterHeader = document.createElement("div");
          chapterHeader.className = "toc-chapter-header";
          const completedBadge =
            chapter.flag === "1"
              ? '<span class="completed-badge">âœ“ å·²å®Œæˆ</span>'
              : "";
          chapterHeader.innerHTML = `
            <span class="toc-toggle">â–¶</span>
            <span>${chapter.name}</span>
            ${completedBadge}
          `;

          const sectionsUl = document.createElement("ul");
          sectionsUl.className = "toc-sections";

          // Add grandchildren (sections)
          if (chapter.grandchildren) {
            chapter.grandchildren.forEach((section) => {
              const sectionLi = document.createElement("li");
              sectionLi.className = "toc-section-item";
              const sectionCompletedBadge =
                section.flag === "1"
                  ? '<span class="completed-badge">âœ“</span>'
                  : "";
              sectionLi.innerHTML = `${section.name}${sectionCompletedBadge}`;
              sectionLi.dataset.node = JSON.stringify(section);

              // Add great-grandchildren (knowledge points)
              if (
                section["great-grandchildren"] &&
                section["great-grandchildren"].length > 0
              ) {
                const kpUl = document.createElement("ul");
                kpUl.className = "toc-knowledge-points";

                section["great-grandchildren"].forEach((kp) => {
                  const kpLi = document.createElement("li");
                  kpLi.className = "toc-knowledge-item";
                  const kpCompletedBadge =
                    kp.flag === "1"
                      ? '<span class="completed-badge">âœ“</span>'
                      : "";
                  kpLi.innerHTML = `${kp.name}${kpCompletedBadge}`;
                  kpLi.dataset.node = JSON.stringify(kp);

                  kpLi.addEventListener("click", (e) => {
                    e.stopPropagation();
                    handleNodeSelect(kp);
                  });

                  kpUl.appendChild(kpLi);
                });

                sectionLi.appendChild(kpUl);
              }

              sectionLi.addEventListener("click", (e) => {
                e.stopPropagation();
                handleNodeSelect(section);
              });

              sectionsUl.appendChild(sectionLi);
            });
          }

          chapterHeader.addEventListener("click", () => {
            const toggle = chapterHeader.querySelector(".toc-toggle");
            toggle.classList.toggle("expanded");
            sectionsUl.classList.toggle("show");
            chapterHeader.classList.toggle("active");
          });

          chapterLi.appendChild(chapterHeader);
          chapterLi.appendChild(sectionsUl);
          tocTree.appendChild(chapterLi);
        });
      }

      // Handle node selection
      function handleNodeSelect(node) {
        console.log("Node selected:", node);
        currentNode = node;

        // Update active state
        document
          .querySelectorAll(".toc-section-item, .toc-knowledge-item")
          .forEach((el) => {
            el.classList.remove("active");
          });
        event.target.classList.add("active");

        // Process resources
        let resources = node.resource_path;
        let resourceArray = [];

        if (typeof resources === "string") {
          if (resources.trim()) {
            resourceArray = [resources.trim()];
          }
        } else if (Array.isArray(resources)) {
          resourceArray = resources.filter((r) => r && r.trim());
        }

        currentResources = resourceArray;

        // Show resource container
        document.getElementById("welcome-screen").style.display = "none";
        document.getElementById("resource-container").style.display = "flex";

        // Update resource title
        document.getElementById("resource-title").textContent = node.name;

        // Render resource list
        renderResourceList(resourceArray);

        // If has resources, auto-select first one
        if (resourceArray.length > 0) {
          selectResource(resourceArray[0], 0);
        } else {
          showNoResource();
        }
      }

      // Render resource list
      function renderResourceList(resources) {
        const resourceList = document.getElementById("resource-list");
        resourceList.innerHTML = "";

        if (resources.length === 0) {
          resourceList.innerHTML =
            '<div style="color: var(--text-dim); font-size: 12px;">è¯¥èŠ‚ç‚¹æš‚æ— èµ„æº</div>';
          return;
        }

        resources.forEach((resource, index) => {
          const badge = document.createElement("div");
          badge.className = "resource-badge";

          const isVideo =
            resource.startsWith("http://") || resource.startsWith("https://");

          if (isVideo) {
            badge.textContent = `ğŸ¬ è§†é¢‘ ${index + 1}`;
          } else {
            const filename = resource
              .split("/")
              .pop()
              .replace(/\.pdf$/i, "");
            badge.textContent = `ğŸ“„ ${filename}`;
          }

          badge.dataset.index = index;
          badge.dataset.resource = resource;

          badge.addEventListener("click", () => {
            selectResource(resource, index);
          });

          resourceList.appendChild(badge);
        });
      }

      // Select and display resource
      async function selectResource(resource, index) {
        // Update active state
        document.querySelectorAll(".resource-badge").forEach((badge) => {
          badge.classList.toggle("active", badge.dataset.index == index);
        });

        const isVideo =
          resource.startsWith("http://") || resource.startsWith("https://");

        // Hide all viewers
        document.getElementById("no-resource").style.display = "none";
        document.getElementById("pdf-viewer").style.display = "none";
        document.getElementById("video-player").style.display = "none";

        // Clean up previous HLS instance
        if (currentHls) {
          currentHls.destroy();
          currentHls = null;
        }

        if (isVideo) {
          // Show video
          const video = document.getElementById("video-player");
          video.style.display = "block";

          if (Hls.isSupported()) {
            currentHls = new Hls();
            currentHls.loadSource(resource);
            currentHls.attachMedia(video);
            currentHls.on(Hls.Events.MANIFEST_PARSED, function () {
              video.play();
            });
          } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
            video.src = resource;
            video.addEventListener("loadedmetadata", function () {
              video.play();
            });
          }
        } else {
          // Show PDF
          const pdfViewer = document.getElementById("pdf-viewer");
          pdfViewer.style.display = "block";

          // Notify backend about PDF selection for RAG
          try {
            await fetch(`${API_BASE}/api/pdf/select`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ pdf_path: resource }),
            });
            console.log("PDF selected for RAG:", resource);
          } catch (error) {
            console.error("Error selecting PDF:", error);
          }

          pdfViewer.src = `${API_BASE}/api/pdf/${encodeURIComponent(resource)}`;
        }
      }

      // Show no resource message
      function showNoResource() {
        document.getElementById("no-resource").style.display = "flex";
        document.getElementById("pdf-viewer").style.display = "none";
        document.getElementById("video-player").style.display = "none";
      }

      // Setup event listeners
      function setupEventListeners() {
        // AI tabs
        document.querySelectorAll(".ai-tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            const targetTab = tab.dataset.tab;
            switchAITab(targetTab);
          });
        });

        // Chat
        document
          .getElementById("send-chat-btn")
          .addEventListener("click", sendChatMessage);
        document
          .getElementById("chat-input")
          .addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendChatMessage();
          });

        // Summary
        document
          .getElementById("generate-summary-btn")
          .addEventListener("click", generateSummary);

        // Quiz
        document
          .getElementById("start-quiz-btn")
          .addEventListener("click", () => {
            // Use current node name as topic
            if (currentNode && currentNode.name) {
              window.location.href = `/static/quizpage.html?topic=${encodeURIComponent(
                currentNode.name
              )}`;
            } else {
              alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªçŸ¥è¯†ç‚¹");
            }
          });

        document.querySelectorAll(".quiz-topic-item").forEach((item) => {
          item.addEventListener("click", () => {
            const topic = item.dataset.topic;
            window.location.href = `/static/quizpage.html?topic=${encodeURIComponent(
              topic
            )}`;
          });
        });
      }

      // Switch AI tab
      function switchAITab(tabName) {
        document.querySelectorAll(".ai-tab").forEach((tab) => {
          tab.classList.toggle("active", tab.dataset.tab === tabName);
        });

        document.querySelectorAll(".ai-content").forEach((content) => {
          content.classList.toggle(
            "active",
            content.id === `${tabName}-content`
          );
        });

        // Show/hide chat input area based on tab
        const chatInputArea = document.querySelector(".chat-input-area");
        chatInputArea.style.display = tabName === "chat" ? "block" : "none";
      }

      // Send chat message
      async function sendChatMessage() {
        const input = document.getElementById("chat-input");
        const message = input.value.trim();
        if (!message) return;

        const messagesContainer = document.getElementById("chat-messages");

        // Add user message
        const userMsg = document.createElement("div");
        userMsg.className = "chat-message user";
        userMsg.textContent = message;
        messagesContainer.appendChild(userMsg);

        input.value = "";

        // Add loading message
        const loadingMsg = document.createElement("div");
        loadingMsg.className = "chat-message loading";
        loadingMsg.innerHTML = '<span class="loading-dots">æ€è€ƒä¸­</span>';
        messagesContainer.appendChild(loadingMsg);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        try {
          const response = await fetch(`${API_BASE}/api/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              message: message,
              history: chatHistory,
              lang_choice: "ğŸŒ Auto-detect",
            }),
          });

          const data = await response.json();

          // Remove loading message
          loadingMsg.remove();

          // Add bot message
          const botMsg = document.createElement("div");
          botMsg.className = "chat-message bot markdown-content";
          botMsg.innerHTML = marked.parse(data.response);
          messagesContainer.appendChild(botMsg);

          chatHistory.push([message, data.response]);
          messagesContainer.scrollTop = messagesContainer.scrollHeight;
        } catch (error) {
          console.error("Error sending chat message:", error);
          loadingMsg.remove();

          const errorMsg = document.createElement("div");
          errorMsg.className = "chat-message bot";
          errorMsg.textContent = "æŠ±æ­‰ï¼Œå‘ç”Ÿé”™è¯¯ã€‚è¯·ç¨åå†è¯•ã€‚";
          messagesContainer.appendChild(errorMsg);
        }
      }

      // Generate summary
      async function generateSummary() {
        const topic = document.getElementById("summary-topic").value.trim();

        if (!topic) {
          alert("è¯·è¾“å…¥è¦æ€»ç»“çš„ä¸»é¢˜");
          return;
        }

        const output = document.getElementById("summary-output");
        output.innerHTML =
          '<p style="color: var(--text-dim);">â³ æ­£åœ¨ç”Ÿæˆæ€»ç»“...</p>';

        try {
          const response = await fetch(`${API_BASE}/api/summary`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              topic: topic,
              lang_choice: "ğŸŒ Auto-detect",
            }),
          });

          const data = await response.json();
          const notice = data.used_retriever
            ? '<p style="color: var(--primary-blue); font-size: 12px; margin-bottom: 12px;">ğŸ“„ ä½¿ç”¨æ–‡æ¡£ä¸Šä¸‹æ–‡ç”Ÿæˆ</p>'
            : "";

          output.innerHTML = notice + marked.parse(data.summary);
          output.classList.add("markdown-content");
        } catch (error) {
          console.error("Error generating summary:", error);
          output.innerHTML = '<p style="color: red;">âŒ ç”Ÿæˆæ€»ç»“å¤±è´¥</p>';
        }
      }
    </script>
  </body>
</html>
